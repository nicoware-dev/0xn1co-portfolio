---
import Layout from "../layouts/Layout.astro";
import Header from "../components/header/Header.astro";
import { mainMenu } from "../components/data/menuData";
import Footer from "../components/Footer/Footer.astro";
import Title from "../components/atoms/Title.astro";
import Card from "../components/card-portfolio/CardPortfolio.astro";
import { portafolioData, categoryTitles } from "../components/data/portfolioData";

const categories = [
    { slug: 'all', title: 'All Projects' },
    ...Object.entries(categoryTitles).map(([slug, title]) => ({ slug, title }))
];
---

<Layout
	title="Portfolio | Nicolas Dominici"
	description="Explore my portfolio of AI automation projects, web development work, and innovative solutions."
	image="/og-image.png"
	type="website"
>
    <Header origin={mainMenu} />
    <main class="pt-40 pb-20 px-4">
        <div class="max-w-[var(--max-width)] mx-auto">
            <div class="text-center mb-12">
                <Title contenido="Portfolio" />
                <h2 class="subtitle">My Recent Work</h2>
            </div>
            
            <div class="filters-container mb-12">
                <div class="filters-scroll">
                    {categories.map((category, index) => (
                        <button 
                            class={`filter-btn ${index === 0 ? 'active' : ''}`}
                            data-filter={category.slug}
                        >
                            {category.title}
                        </button>
                    ))}
                </div>
            </div>

            <div class="portfolio-grid" id="portfolio-grid">
                {portafolioData.map(project => (
                    <div class="project-item" data-category={Array.isArray(project.category) ? project.category.join(',') : project.category}>
                        <Card {...project} />
                    </div>
                ))}
            </div>
            
            <div id="no-results" class="hidden text-center py-12">
                <p class="text-[var(--primary-80)] text-xl">No projects found in this category.</p>
            </div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    document.addEventListener('astro:page-load', () => {
        initPortfolio();
    });

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initPortfolio();
    } else {
        document.addEventListener('DOMContentLoaded', initPortfolio);
    }

    function initPortfolio() {
        const filterBtns = document.querySelectorAll('.filter-btn');
        const projectItems = document.querySelectorAll('.project-item');
        const noResults = document.getElementById('no-results');

        // Check for URL query param
        const urlParams = new URLSearchParams(window.location.search);
        const initialCategory = urlParams.get('category');

        if (initialCategory) {
            const btn = document.querySelector(`.filter-btn[data-filter="${initialCategory}"]`);
            if (btn) {
                // Simulate click to filter
                (btn as HTMLElement).click();
            }
        }

        if (!filterBtns.length || !projectItems.length) return;

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons
                filterBtns.forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                btn.classList.add('active');

                const filterValue = btn.getAttribute('data-filter') || '';
                let visibleCount = 0;

                projectItems.forEach(item => {
                    const categoryAttr = item.getAttribute('data-category');
                    const categories = categoryAttr ? categoryAttr.split(',') : [];
                    
                    if (filterValue === 'all' || categories.includes(filterValue)) {
                        (item as HTMLElement).style.display = 'block';
                        // Add animation class for re-appearing items
                        item.classList.add('fade-in');
                        setTimeout(() => item.classList.remove('fade-in'), 500);
                        visibleCount++;
                    } else {
                        (item as HTMLElement).style.display = 'none';
                    }
                });

                if (noResults) {
                    noResults.classList.toggle('hidden', visibleCount > 0);
                }
            });
        });
        
        // If we have an initial category, trigger the filter logic
        if (initialCategory) {
             const btn = document.querySelector(`.filter-btn[data-filter="${initialCategory}"]`);
             if (btn) {
                 // We need to manually trigger the logic because the click event might not be ready or we want to avoid animation on load if possible, 
                 // but clicking is easiest. However, the event listener is added inside this function.
                 // So we can just call the logic directly or dispatch event.
                 // Dispatching click is fine.
                 btn.dispatchEvent(new Event('click'));
             }
        }
    }
</script>

<style>
    .subtitle {
        font-size: 2.4rem;
        color: var(--primary-90);
        margin-top: 1rem;
    }

    .filters-container {
        display: flex;
        justify-content: center;
        width: 100%;
    }

    .filters-scroll {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 100px;
    }

    .filter-btn {
        background: transparent;
        border: none;
        color: var(--primary-80);
        padding: 0.8rem 2rem;
        border-radius: 100px;
        font-size: 1.4rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: var(--font-body);
    }

    .filter-btn:hover {
        color: var(--primary-100);
        background: rgba(255, 255, 255, 0.05);
    }

    .filter-btn.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .portfolio-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 3rem;
    }

    .project-item {
        animation: fadeIn 0.5s ease forwards;
    }

    .project-item.fade-in {
        animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .filters-scroll {
            border-radius: 20px;
            padding: 1rem;
        }
        
        .portfolio-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
